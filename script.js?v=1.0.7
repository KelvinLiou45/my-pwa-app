// 註冊 Service Worker，讓網站具備離線與更新能力
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js?v=1.0.4').then(reg => {
    console.log('[SW] 已註冊於:', reg.scope);

    // 當有新版本安裝中時觸發
    reg.onupdatefound = () => {
      const newWorker = reg.installing;
      newWorker.onstatechange = () => {
        // 當新 SW 安裝完成，且已有舊版在控制時
        if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
          // 顯示提示讓使用者選擇是否立即更新
          if (confirm('有新版本可用，是否立即重新整理套用？')) {
            newWorker.postMessage({ action: 'skipWaiting' });
          }
        }
      };
    };
  });

  // 當新版 Service Worker 接管後，重新載入頁面
  let refreshing;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (refreshing) return;
    refreshing = true;
    window.location.reload();
  });
}

// 每 5 分鐘自動檢查更新
setInterval(() => {
  if (navigator.serviceWorker && navigator.serviceWorker.controller) {
    navigator.serviceWorker.getRegistration().then(reg => {
      if (reg) {
        reg.update(); // 強制檢查有無更新的 service worker
      }
    });
  }
}, 1 * 60 * 1000); // 5 分鐘
